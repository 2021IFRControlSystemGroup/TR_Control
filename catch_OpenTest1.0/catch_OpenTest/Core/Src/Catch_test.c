#include "robo_base.h"
#include "can.h"
#include "Catch_test.h"
#include "main.h"

//extern ROBO_BASE Robo_Base; 
//extern Speed_System* P_Speed; 
extern ROBO_CATCH robo_catch;
extern CAN_HandleTypeDef hcan1;
int speed;
int pos;
int flag;

int state;
int shot;
//void catch_open(void)
//{

//	
//   switch(robo_catch.Open_flag)
//	 {
//	   case 1:robo_catch.SPEED_systemOpen.Tar_Speed=-speed;break;        
//	   case 2:robo_catch.SPEED_systemOpen.Tar_Speed=speed;break;	
//     case 0:robo_catch.SPEED_systemOpen.Tar_Speed=0;break;		
//     default:break;		 
//	 }
//      
//}

////速度环标定
//void catch_line_speed(void)
//{
//	 switch(robo_catch.Line_flag)  //1.3移动到中间停止，1.2.3移动到一端再回到中间。
//	 {
//	   case 1:robo_catch.SPEED_systemLine.Tar_Speed=100;break;        
//	   case 0:robo_catch.SPEED_systemLine.Tar_Speed=0;break;	
//     case 2:robo_catch.SPEED_systemLine.Tar_Speed=-100;break;		 
//		 default:break;
//	 }
//     
//}


////五个位置
//void catch_line_pos(void)
//{
//	 switch(robo_catch.Line_flag)  //移动一个角度
//	 {
//	   case 1:robo_catch.Pos_systemLine.Tar_Pos=pos;break;        
//	   case 2:robo_catch.Pos_systemLine.Tar_Pos=-pos;break;	
//     case 0:robo_catch.Pos_systemLine.Tar_Pos=0;break;		 
//		 default:break;
//	 }
//     
//}


WorkState_e Work_Status = PREPARE_STATE;
static int PosCount =5;
int last_Open;
int last_Line;
//获取状态
uint8_t GetWorkStatus(void)
{
	return Work_Status;
}

void Work_Mode_Change(void)
{
		switch(GetWorkStatus())
	{
		case PREPARE_STATE:
		{
			  PosCount=5;
				robo_catch.SPEED_systemOpen.Tar_Speed=0;
			  robo_catch.SPEED_systemLine.Tar_Speed=0;
	      flag=0;	      
			  HAL_Delay(1000);
			  Work_Status = CALIBRATION_LINE;
			break;
		}
		case CALIBRATION_LINE:  //01  OK
		{
			if(robo_catch.line_speed_flag)
			{
			    robo_catch.SPEED_systemLine.Tar_Speed = -300;
				  robo_catch.SPEED_systemOpen.Tar_Speed=0;
			    flag=0;	 
				  Work_Status = CALIBRATION_LINE;
			}
			else
				{
				  Work_Status = CALIBRATION_CLIP;
					robo_catch.SPEED_systemLine.Tar_Speed = 0;   
					robo_catch.SPEED_systemOpen.Tar_Speed=100;     
					flag=0;
				}					
					
			break;
		}
		case CALIBRATION_CLIP:  //02  ok
		{
			if(robo_catch.open_flag == 0)
			{
			    robo_catch.SPEED_systemOpen.Tar_Speed = 0;
				  robo_catch.SPEED_systemLine.Tar_Speed = 0;
			    flag = 0;
				 Work_Status = OPEN_STATE;
				last_Open = robo_catch.Pos_systemOpen.Info.Abs_Angle;
				last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;
				
			}
			break;
		}
		case OPEN_STATE:   //03     ok 
		{
				if(robo_catch.SPEED_systemOpen.Info.Speed == 0)
			{
         HAL_Delay(500);			
				 if(robo_catch.SPEED_systemOpen.Info.Speed == 0 && robo_catch.open_flag == 0 && state == 3)
				 {
						robo_catch.Pos_systemOpen.Tar_Pos = 20000 + last_Open;       //这进4疯了  open疯
						robo_catch.Pos_systemLine.Tar_Pos = last_Line;
						flag = 1;
						Work_Status = CLOSE_STATE;
						last_Open = robo_catch.Pos_systemOpen.Info.Abs_Angle;
						last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;
				 }
			}			
	    break;
		}
		case CLOSE_STATE:  //04 OK
		{	
			if(robo_catch.SPEED_systemOpen.Info.Speed == 0)
			{
         HAL_Delay(500);			
				 if(robo_catch.SPEED_systemOpen.Info.Speed == 0)
				 {
					  if(state == 4) //抓取到置位4
			      {
			           robo_catch.Pos_systemOpen.Tar_Pos =  - 20000+last_Open ;        
				         robo_catch.Pos_systemLine.Tar_Pos = last_Line ;      
				         flag = 1;
				         Work_Status = ENDPOINT_STATE;
				         last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;
				         last_Open = robo_catch.Pos_systemOpen.Info.Abs_Angle;
			      } 
				 }
			}			
			
			break;
		}
		case ENDPOINT_STATE:    //05  OK     
		{
//			if(robo_catch.SPEED_systemOpen.Info.Speed == 0)
//			{
//         HAL_Delay(1000);			
//				 if(robo_catch.SPEED_systemOpen.Info.Speed == 0)
//					 state = 5;
//			}
			
			if((robo_catch.SPEED_systemOpen.Info.Speed == 0) && (state == 5))   
			{
			    robo_catch.Pos_systemLine.Tar_Pos = 10000 +last_Line;
		//		  robo_catch.Pos_systemOpen.Tar_Pos = last_Open;   //来回转到效果
			    flag = 1;
				  Work_Status = POS_STATE;
					last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;
			}
				
			break;
		}
		case POS_STATE:   //06       OK来回
		{
//			if(robo_catch.SPEED_systemLine.Info.Speed == 0)
//			{
//         HAL_Delay(1000);			
//				 if(robo_catch.SPEED_systemLine.Info.Speed == 0)
//					 state = 6;
//			}
			if((robo_catch.SPEED_systemLine.Info.Speed == 0) && (state == 6) && (shot == 1))     //箭与发射架接好后置位6  发射完shot置位1 ，5次
			{
					if(PosCount>0) 
					{
							robo_catch.Pos_systemLine.Tar_Pos = -1000+last_Line;    //一正一反
				//		  robo_catch.Pos_systemOpen.Tar_Pos = last_Open;
							flag = 1;			
							PosCount--;
							Work_Status = POS_STATE;
							last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;   //
						last_Open = robo_catch.Pos_systemOpen.Info.Abs_Angle;
	//				last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;
							shot = 0;
							}
					else 
					{
						PosCount = 5;
						Work_Status = RESTART_LINE;		
					}
				}	
     break;
			}
	
		
		case RESTART_LINE:  //07              OK           
		{
			if(robo_catch.line_speed_flag)
			{
			  robo_catch.SPEED_systemLine.Tar_Speed = 500;
			  robo_catch.SPEED_systemOpen.Tar_Speed = 0;
				flag = 0;
				Work_Status = RESTART_LINE;
			}
			else
			{
				robo_catch.SPEED_systemLine.Tar_Speed = 0;
			  robo_catch.SPEED_systemOpen.Tar_Speed = 500;
				flag=0;
			  Work_Status = RESTART_CLIP;
			}		 
			     

			break;
		}
		
		case RESTART_CLIP:  //08  ok
		{
			if(robo_catch.open_flag == 0)
			{
			    robo_catch.SPEED_systemLine.Tar_Speed = 0;
			    robo_catch.SPEED_systemOpen.Tar_Speed= 0;
			    flag = 0;
			    Work_Status = OPEN_STATE;
				  last_Line = robo_catch.Pos_systemLine.Info.Abs_Angle;
				  last_Open = robo_catch.Pos_systemOpen.Info.Abs_Angle;
			} 	
			break;
		}
		
	}
}



